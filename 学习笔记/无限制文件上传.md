# [无限制文件上传](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)

## 描述

上传文件对应用程序来说意味着风险。许多攻击第一步是向系统中输入一些可以被攻击的代码，然后这只需要找到一种方法使这些代码执行。文件上传可以帮助攻击者完成第一步。

不受限制的文件上传的后果可能会有所不同，包括完成系统接管，使文件系统或数据库超负载，转发攻击到后端系统，客户端攻击，或者简单的破坏。这取决于应用程序如何处理上传的文件，特别是它存储在何处。

这里实际有两类问题。第一个是关于文件元数据，例如文件路径和名称。这通常由传输提供，例如HTTP多部分编码。这个数据可能欺骗应用程序去重写一个危险文件或将文件存储在一个不好的地方。在使用这些文件时，你必须非常小心的去验证这些文件。

另外一个问题是关于文件大小和内容。这里的问题范围完全取决于文件的用途。请参阅下面的示例，了解文件可能如何被滥用。为了防范这类攻击，你应该分析应用程序对文件所做的所有事情，并且仔细思考涉及哪些处理和解释器。

## 危险因素

* 此漏洞的影响很大，假定的代码可以在服务器上下文中或在客户端执行。被攻击者发现的可能性很高。这种现象很普遍。因此，这类脆弱性的严重程度很高。
* 检查文件上传模块的访问控制以正确地检查风险是很重要的。
* 服务端攻击：web服务器可以通过上传和执行网站后门工具而被破坏，网站后门工具可以运行命令、浏览系统文件、浏览本地资源、攻击其他服务器或利用本地漏洞，等等。
* 客户端攻击：上传恶意文件可以使网站容易受到客户端攻击，如跨站攻击或跨站内容劫持。
* 当文件在相同或受信服务器上被需要时，上传的文件可能被滥用，以利用应用程序的其他脆弱部分(可能再次导致客户端或服务器端攻击)。
* 上传的文件可能会在客户被损坏的函数库或应用程序中触发漏洞（例如，iPhone MobileSafari LibTIFF缓冲区溢出）。
* 上传的文件可能会在服务端被损坏的函数库或应用程序中触发漏洞（例如，ImageMagick漏洞被ImageTragick调用）。
* 上传的文件可能会在被损坏的实时监控工具中触发漏洞（例如，Symantec antivirus exploit by unpacking a RAR file）
* 管理员或网站管理员可以将Unix shell脚本、windows病毒、带有危险公式的Excel文件或反向shell等恶意文件上传到服务器上，以便稍后在受害者的机器上执行代码。
* 攻击者可能会在网站中放置钓鱼页面或损毁网站。
* 文件存储服务器可能被滥用来托管麻烦的文件，包括恶意软件，非法软件，或成人内容。上传的文件也可能包含恶意软件的命令和控制数据，暴力和骚扰信息，或可被犯罪组织使用的隐写数据。
* 上传的敏感文件可能会被未授权的人访问。
* 文件上传者可能会在他们的错误消息中透露内部信息，比如服务器内部路径。

## 例子

### 对应用平台的攻击

* 上传.jsp文件到web树 - jsp代码作为web用户执行
* 上传.gif文件调整大小 - 图像库缺陷被利用
* 上传大文件 - 文件空间拒绝服务
* 上传文件使用恶意路径或名称 - 覆盖关键文件
* 上传文件包含个人数据 - 其他用户访问它
* 文件包含“tags” - 标签作为“包含”在web页面中的一部分被执行
* 上传的.rar文件将被防病毒扫描 - 在运行有漏洞的杀毒软件的服务器上执行的命令

### 对其他系统的攻击

* 上传.exe文件到web树 - 受害者下载木马可执行文件
* 上传被病毒感染的文件 - 受害者的机器被感染
* 上传包含脚本的.html文件 - 受害者经历[跨站点脚本攻击(XSS)](https://owasp.org/www-community/vulnerabilities/Cross-site_Scripting_/(XSS/))
* 上传包含Flash对象的.jpg文件 - 受害者会经历跨站点内容劫持。
* 上传.rar文件将被防病毒扫描 - 在运行有漏洞的杀毒软件的客户端上执行的命令

## 弱保护和旁路方法

### 拒绝列出文件扩展名

这种保护可能被绕过:

* 查找可以在服务器端执行或在客户端可能会有危险的丢失的扩展（例如：“.php5”, “.pht”, “.phtml”, “.shtml”, “.asa”, “.cer”, “.asax”, “.swf”, or “.xap”）。
* 查找web服务器配置中的缺陷，当它解析具有双重扩展名的文件时，或者通过在分隔符(如“/”或“;”)后提供敏感扩展名来执行文件时。（例如：“/file.jpg/index.php”当“file.jpg”文件包含PHP代码，并且已上传时。）
  * 在Apache中，当允许使用" .jpg "时，可以使用" file.php.jpg "等双扩展技术来执行php文件。
  * 在IIS6(或以前的版本)中，可以使用这两种方法中的一种来执行脚本文件：
    * 通过在禁止扩展名之后和允许扩展名之前添加分号(例如" file.asp;.jpg ")
    * 通过将一个脚本文件的扩展名(如“.asp”)重命名为一个文件夹中允许的扩展名(如“.txt”)，该文件夹的名称以该脚本的扩展名结尾(如“文件夹.asp\文件.txt”)。在Windows中，可以使用文件上传器和ADS(替代数据流)创建目录。在这种方法中，以“::$Index_Allocation”或“:$I30:$Index_Allocation”结尾的文件名使文件上传者创建一个目录而不是一个文件(例如“文件夹”)。asp:: $ Index_Allocation“创建”文件夹中。作为目录)。
* 将一些字母更改为大写形式，以绕过大小写敏感规则(如“file.aSp”或“file.PHp3”)。
* 使用Windows 8.3功能，可以通过使用它们的短名称来替换现有文件(例如“web.config”可以被“web~1.con”替代，“.haccess”可以被“HTACCE~1”替代)。
* 查找在文件上传过程中转换为其他有用字符的字符。例如，当在IIS上运行PHP时，">"，"<"，和双引号"字符分别转换为"?"， "*"，和"."可以用来替换现有文件的字符(如" web<< "可以替换"web.config文件)。为了在普通文件上传请求的文件名中包含双引号字符，" Content-Disposition "头文件中的文件名应使用单引号(例如filename= 'web " config'来代替“web .config”文件)。
* 查找文件名后的中立字符，如Windows文件系统中的尾随空格和点，或Linux文件系统中的点和斜杠字符。文件名末尾的这些字符将被自动删除 (例如： “file.asp … … . . .. ..”, “file.asp “,或“file.asp.”)。虽然斜杠或反斜杠字符通常也是有问题的字符，但在正常的文件上传请求中，它们可以被忽略，因为在服务器端，这些字符可以作为目录名;也就是说，应该对它们进行彻底的测试(例如： “test.php/” 或 “test.php.\”)。
